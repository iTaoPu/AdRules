name: Update Rules
on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    paths:
      - 'script/*'
      - 'mod/*'
      - 'index.html'
      - '.github/workflows/*'
  workflow_dispatch:

jobs:
  update-rules:
    runs-on: ubuntu-latest
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
    - name: Setup Python and Install Dependencies
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    # æ­¥éª¤3ï¼šæ›´æ–°ä¸Šæ¸¸è§„åˆ™
    - name: Update Upstream Rules
      run: |
        echo "å¼€å§‹å®‰è£…Pythonä¾èµ–åº“..."
        pip install --quiet requests beautifulsoup4 lxml
        
        echo "æ‰§è¡Œä¸Šæ¸¸è§„åˆ™æ›´æ–°..."
        if [ ! -f "./script/update_upstream.sh" ]; then
          echo "é”™è¯¯ï¼šupdate_upstream.sh è„šæœ¬ä¸å­˜åœ¨"
          exit 3
        fi
        
        # æ‰§è¡Œæ›´æ–°è„šæœ¬
        bash ./script/update_upstream.sh
        
        # æ£€æŸ¥è„šæœ¬æ‰§è¡Œç»“æœ
        if [ $? -ne 0 ]; then
          echo "é”™è¯¯ï¼šä¸Šæ¸¸è§„åˆ™æ›´æ–°å¤±è´¥"
          exit 3
        fi
        
        echo "æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶..."
        if [ -d "./tmp" ] && [ "$(ls -A ./tmp 2>/dev/null)" ]; then
          echo "æ‰“åŒ…ä¸´æ—¶æ–‡ä»¶..."
          tar -czvf archive.tar.gz ./tmp/*
          echo "æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(du -h archive.tar.gz | cut -f1)"
        else
          echo "è­¦å‘Šï¼štmpç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          touch archive.tar.gz  # åˆ›å»ºç©ºæ–‡ä»¶é¿å…åç»­é”™è¯¯
        fi
        
        echo "ä¸Šæ¸¸è§„åˆ™æ›´æ–°å®Œæˆ"
    
    # æ­¥éª¤4ï¼šä¸Šä¼ ä¸´æ—¶æ–‡ä»¶ä½œä¸ºå·¥ä»¶ï¼ˆå¯é€‰ï¼‰
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: archive.tar.gz
        path: archive.tar.gz
        retention-days: 1
    
    # æ­¥éª¤5ï¼šæ„å»ºè§„åˆ™æ–‡ä»¶
    - name: Build Rule Files
      run: |
        echo "å¼€å§‹æ„å»ºè§„åˆ™æ–‡ä»¶..."
        
        # æ£€æŸ¥è„šæœ¬ç›®å½•
        if [ ! -d "./script" ]; then
          echo "é”™è¯¯ï¼šscriptç›®å½•ä¸å­˜åœ¨"
          exit 3
        fi
        
        # æ‰§è¡Œæ„å»ºè„šæœ¬
        echo "æ‰§è¡Œ update_content.sh..."
        if [ -f "./script/update_content.sh" ]; then
          bash ./script/update_content.sh
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯ï¼šupdate_content.sh æ‰§è¡Œå¤±è´¥"
            exit 3
          fi
        else
          echo "è­¦å‘Šï¼šupdate_content.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        
        echo "æ‰§è¡Œ update_dns.sh..."
        if [ -f "./script/update_dns.sh" ]; then
          bash ./script/update_dns.sh
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯ï¼šupdate_dns.sh æ‰§è¡Œå¤±è´¥"
            exit 3
          fi
        else
          echo "è­¦å‘Šï¼šupdate_dns.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f archive.tar.gz
        echo "è§„åˆ™æ–‡ä»¶æ„å»ºå®Œæˆ"
    
    # æ­¥éª¤6ï¼šæ›´æ–°å…¶ä»–è§„åˆ™ï¼ˆå¯é€‰ï¼‰
    - name: Update Additional Rules
      run: |
        echo "æ›´æ–°é¢å¤–è§„åˆ™..."
        
        # åˆ›å»ºè§„åˆ™ç›®å½•
        mkdir -p rules 2>/dev/null || true
        
        # ä¸‹è½½é¢å¤–è§„åˆ™æ–‡ä»¶ï¼ˆä½¿ç”¨curlï¼Œæ›´å¥½çš„é”™è¯¯å¤„ç†ï¼‰
        echo "ä¸‹è½½ jiekouAD.txt..."
        curl -f -L -s -o rules/jiekouAD.txt \
          https://raw.githubusercontent.com/damengzhu/banad/main/jiekouAD.txt \
          && echo "ä¸‹è½½æˆåŠŸ" || echo "è­¦å‘Šï¼šä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡"
        
        # æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶
        if [ -f "rules/jiekouAD.txt" ]; then
          if [ -s "rules/jiekouAD.txt" ]; then
            echo "è§„åˆ™æ–‡ä»¶æœ‰æ•ˆï¼Œè¡Œæ•°: $(wc -l < rules/jiekouAD.txt)"
          else
            echo "è­¦å‘Šï¼šè§„åˆ™æ–‡ä»¶ä¸ºç©º"
            rm -f rules/jiekouAD.txt
          fi
        fi
    
    # æ­¥éª¤7ï¼šæäº¤å¹¶æ¨é€åˆ°å½“å‰GitHubä»“åº“
    - name: Commit and Push to GitHub
      run: |
        echo "å‡†å¤‡æäº¤æ›´æ–°..."
        
        # é…ç½®Gitç”¨æˆ·
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´çŠ¶æ€..."
        git status --porcelain
        
        # æ·»åŠ æ‰€æœ‰è§„åˆ™ç›¸å…³æ–‡ä»¶
        echo "æ·»åŠ éœ€è¦æäº¤çš„æ–‡ä»¶..."
        
        # å…ˆæ·»åŠ å·²çŸ¥æ–‡ä»¶ç±»å‹
        git add *.txt *.conf *.list *.json *.html *.srs *.mrs 2>/dev/null || true
        
        # æ·»åŠ è§„åˆ™ç›®å½•ä¸‹çš„æ–‡ä»¶
        if [ -d "rules" ]; then
          git add rules/* 2>/dev/null || true
        fi
        
        # æ·»åŠ modç›®å½•ä¸‹çš„æ–‡ä»¶
        if [ -d "mod" ]; then
          git add mod/* 2>/dev/null || true
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„å˜æ›´
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          exit 0
        fi
        
        # æäº¤å˜æ›´
        echo "æäº¤å˜æ›´..."
        commit_message="ğŸ¤– Auto Update: $(TZ=UTC-8 date +'%Y-%m-%d %H:%M:%S')"
        
        git commit -m "$commit_message"
        
        # æ¨é€åˆ°è¿œç¨‹ä»“åº“
        echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        git push origin HEAD:${{ github.ref_name }}
        
        if [ $? -eq 0 ]; then
          echo "âœ… æ¨é€æˆåŠŸ"
        else
          echo "âŒ æ¨é€å¤±è´¥"
          exit 128
        fi
    
    # æ­¥éª¤8ï¼šå·¥ä½œæµæ‰§è¡Œæ‘˜è¦
    - name: Workflow Summary
      if: always()
      run: |
        echo "========================================"
        echo "         GitHub Actions æ‰§è¡Œæ‘˜è¦        "
        echo "========================================"
        echo "å·¥ä½œæµåç§°: Update Rules"
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "Gitå¼•ç”¨: ${{ github.ref }}"
        echo "æäº¤SHA: ${{ github.sha }}"
        echo "æ‰§è¡Œç»“æœ: ${{ job.status }}"
        echo "========================================"
