name: Update Rules
on:
  schedule:
    - cron: '0 */6 * * *'
  push:
    paths:
      - 'script/*'
      - 'mod/*'
      - 'index.html'
      - '.github/workflows/*'
  workflow_dispatch:

jobs:
  update-rules:
    runs-on: ubuntu-latest
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºmainåˆ†æ”¯ä»£ç 
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
    - name: Setup Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–å¹¶æ›´æ–°ä¸Šæ¸¸è§„åˆ™
    - name: Install Dependencies and Update Upstream
      run: |
        echo "ğŸš€ å¼€å§‹å®‰è£…Pythonä¾èµ–..."
        pip install --quiet requests beautifulsoup4 lxml
        
        echo "ğŸ“¥ æ‰§è¡Œä¸Šæ¸¸è§„åˆ™æ›´æ–°..."
        
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "./script/update_upstream.sh" ]; then
          echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° update_upstream.sh è„šæœ¬"
          exit 3
        fi
        
        # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
        chmod +x ./script/update_upstream.sh
        
        # æ‰§è¡Œä¸Šæ¸¸æ›´æ–°è„šæœ¬
        bash ./script/update_upstream.sh
        
        # æ£€æŸ¥æ‰§è¡Œç»“æœ
        if [ $? -ne 0 ]; then
          echo "âŒ é”™è¯¯ï¼šä¸Šæ¸¸è§„åˆ™æ›´æ–°è„šæœ¬æ‰§è¡Œå¤±è´¥"
          exit 3
        fi
        
        # æ£€æŸ¥å¹¶æ‰“åŒ…ä¸´æ—¶æ–‡ä»¶
        echo "ğŸ“¦ å¤„ç†ä¸´æ—¶æ–‡ä»¶..."
        if [ -d "./tmp" ] && [ "$(ls -A ./tmp 2>/dev/null)" ]; then
          echo "æ‰“åŒ…ä¸´æ—¶æ–‡ä»¶åˆ° archive.tar.gz"
          tar -czvf archive.tar.gz ./tmp/*
          echo "ğŸ“Š æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $(du -h archive.tar.gz | cut -f1)"
        else
          echo "âš ï¸ è­¦å‘Šï¼štmpç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
          touch archive.tar.gz
        fi
        
        echo "âœ… ä¸Šæ¸¸æ›´æ–°å®Œæˆ"
    
    # æ­¥éª¤4ï¼šä¸Šä¼ å·¥ä»¶ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
    - name: Upload Temporary Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: archive.tar.gz
        path: archive.tar.gz
        retention-days: 1
    
    # æ­¥éª¤5ï¼šæ„å»ºè§„åˆ™æ–‡ä»¶
    - name: Build Final Rules
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºæœ€ç»ˆè§„åˆ™æ–‡ä»¶..."
        
        # æ£€æŸ¥è„šæœ¬ç›®å½•
        if [ ! -d "./script" ]; then
          echo "âŒ é”™è¯¯ï¼šscriptç›®å½•ä¸å­˜åœ¨"
          exit 3
        fi
        
        # æ„å»ºå†…å®¹è§„åˆ™
        echo "æ‰§è¡Œ update_content.sh..."
        if [ -f "./script/update_content.sh" ]; then
          chmod +x ./script/update_content.sh
          bash ./script/update_content.sh
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯ï¼šupdate_content.sh æ‰§è¡Œå¤±è´¥"
            exit 3
          fi
          echo "âœ… update_content.sh æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âš ï¸ è­¦å‘Šï¼šupdate_content.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        
        # æ„å»ºDNSè§„åˆ™
        echo "æ‰§è¡Œ update_dns.sh..."
        if [ -f "./script/update_dns.sh" ]; then
          chmod +x ./script/update_dns.sh
          bash ./script/update_dns.sh
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯ï¼šupdate_dns.sh æ‰§è¡Œå¤±è´¥"
            exit 3
          fi
          echo "âœ… update_dns.sh æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âš ï¸ è­¦å‘Šï¼šupdate_dns.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        echo "ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f archive.tar.gz
        [ -d "./tmp" ] && rm -rf ./tmp/
        
        echo "âœ… è§„åˆ™æ„å»ºå®Œæˆ"
    
    # æ­¥éª¤6ï¼šä¸‹è½½é¢å¤–è§„åˆ™ï¼ˆå¯é€‰ï¼‰
    - name: Download Additional Rules
      run: |
        echo "ğŸŒ ä¸‹è½½é¢å¤–è§„åˆ™..."
        
        # åˆ›å»ºè§„åˆ™ç›®å½•
        mkdir -p rules 2>/dev/null || echo "åˆ›å»ºrulesç›®å½•"
        
        # ä¸‹è½½å¤–éƒ¨è§„åˆ™æ–‡ä»¶
        echo "ä¸‹è½½ jiekouAD.txt..."
        curl -f -L -s -o rules/jiekouAD.txt \
          https://raw.githubusercontent.com/damengzhu/banad/main/jiekouAD.txt
        
        if [ $? -eq 0 ]; then
          echo "âœ… ä¸‹è½½æˆåŠŸ"
          if [ -s "rules/jiekouAD.txt" ]; then
            line_count=$(wc -l < rules/jiekouAD.txt)
            echo "ğŸ“Š è§„åˆ™è¡Œæ•°: $line_count"
          else
            echo "âš ï¸ è­¦å‘Šï¼šä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
            rm -f rules/jiekouAD.txt
          fi
        else
          echo "âš ï¸ è­¦å‘Šï¼šä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡æ­¤è§„åˆ™"
          rm -f rules/jiekouAD.txt 2>/dev/null || true
        fi
    
    # æ­¥éª¤7ï¼šæ¨é€åˆ°mainåˆ†æ”¯
    - name: Push to main Branch
      run: |
        echo "ğŸ“¤ å‡†å¤‡æ¨é€åˆ°mainåˆ†æ”¯..."
        
        # é…ç½®Gitèº«ä»½
        echo "é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥å½“å‰åˆ†æ”¯
        current_branch=$(git branch --show-current)
        echo "å½“å‰åˆ†æ”¯: $current_branch"
        
        # æ˜¾ç¤ºæ–‡ä»¶å˜æ›´çŠ¶æ€
        echo "ğŸ“ æ–‡ä»¶å˜æ›´çŠ¶æ€ï¼š"
        git status --short
        
        # æ·»åŠ æ‰€æœ‰è§„åˆ™ç›¸å…³æ–‡ä»¶
        echo "ğŸ“ æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº..."
        
        # æ·»åŠ æ‰€æœ‰è§„åˆ™æ–‡ä»¶ï¼ˆæ’é™¤å·¥ä½œæµæ–‡ä»¶ï¼‰
        git add --all -- '*.txt' '*.conf' '*.list' '*.json' '*.html' '*.srs' '*.mrs' 'rules/*' 'mod/*' 2>/dev/null || true
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ·»åŠ 
        staged_files=$(git diff --cached --name-only)
        
        if [ -z "$staged_files" ]; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
          exit 0
        fi
        
        echo "å·²æš‚å­˜çš„æ–‡ä»¶ï¼š"
        echo "$staged_files"
        
        # è·å–å˜æ›´çš„è¡Œæ•°
        lines_changed=$(git diff --cached --stat | tail -1)
        
        # æäº¤å˜æ›´åˆ°mainåˆ†æ”¯
        commit_time=$(TZ=UTC-8 date +'%Y-%m-%d %H:%M:%S')
        commit_message="ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™ ($commit_time)"
        
        if [ -n "$lines_changed" ]; then
          commit_message="$commit_message - $lines_changed"
        fi
        
        echo "ğŸ“ æäº¤ä¿¡æ¯ï¼š$commit_message"
        
        git commit -m "$commit_message"
        
        # å¼ºåˆ¶æ¨é€åˆ°mainåˆ†æ”¯
        echo "ğŸš€ æ¨é€åˆ°mainåˆ†æ”¯..."
        git push origin main --force
        
        if [ $? -eq 0 ]; then
          echo "ğŸ‰ âœ… æˆåŠŸæ¨é€åˆ°mainåˆ†æ”¯"
          
          # æ˜¾ç¤ºæ¨é€åçš„çŠ¶æ€
          echo "ğŸ“Š æœ€æ–°æäº¤ä¿¡æ¯ï¼š"
          git log -1 --oneline
        else
          echo "âŒ æ¨é€åˆ°mainåˆ†æ”¯å¤±è´¥"
          echo "é”™è¯¯ä»£ç : $?"
          exit 128
        fi
    
    # æ­¥éª¤8ï¼šæ‰§è¡Œæ‘˜è¦
    - name: Execution Summary
      if: always()
      run: |
        echo " "
        echo "================================================"
        echo "            GitHub Actions æ‰§è¡Œæ‘˜è¦             "
        echo "================================================"
        echo "ğŸ·ï¸  å·¥ä½œæµ: ${{ github.workflow }}"
        echo "ğŸ“¦ ä»“åº“: ${{ github.repository }}"
        echo "ğŸŒ¿ ç›®æ ‡åˆ†æ”¯: main"
        echo "â° æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "âš¡ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "ğŸ”§ è¿è¡Œç¯å¢ƒ: ${{ runner.os }}"
        echo "ğŸ“Š ç»“æŸçŠ¶æ€: ${{ job.status }}"
        echo "================================================"
        echo " "
        
        # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
        df -h | grep -E 'Filesystem|/$'
        
        echo " "
        echo "âœ¨ å·¥ä½œæµæ‰§è¡Œå®Œæˆ âœ¨"
